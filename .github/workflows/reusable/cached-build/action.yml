name: "cached build"
description: "build monorepo and cache result, or restore from cache if present"

runs:
  using: "composite"
  steps:
    - uses: actions/setup-node@v3
      with:
        node-version-file: '.nvmrc'
        cache: 'npm'
        cache-dependency-path: package-lock.json
    - name: cache node_modules
      id: cache-node-modules
      uses: actions/cache@v3
      with:
        key: cache-node-modules-${{ hashFiles('package-lock.json') }}
        path: |
          node_modules
          packages/*/node_modules
    - name: cache build
      id: cache-build
      uses: actions/cache@v3
      with:
        key: cache-build-${{ github.sha }}
        path: |
          packages/*/dist
          packages/client/vendor
          packages/proto-rpc/src/proto
          packages/dht/src/proto
          packages/tracer
    - name: ci
      if: steps.cache-node-modules.outputs.cache-hit != 'true'
      run: |
        version=3.12.0
        archive=protoc-${version}-linux-x86_64.zip
        curl -O -L https://github.com/protocolbuffers/protobuf/releases/download/v${version}/${archive}
        sudo unzip -d '/usr/local' ${archive} 'bin/*' 'include/*'
        sudo chmod 755 /usr/local/bin/protoc
        rm ${archive}
        protoc --version
        npm ci --no-audit
      shell: bash
    - name: build
      if: steps.cache-build.outputs.cache-hit != 'true'
      run: npm run build
      shell: bash
